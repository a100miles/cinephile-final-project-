<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Profile • Cinephile</title>

	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Google+Sans+Flex:wght@100..1000&family=Lora:wght@400..700&display=swap" rel="stylesheet">

	<link href="/output.css" rel="stylesheet" />
	<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.6.2/axios.min.js"></script>
</head>

<body class="min-h-screen font-sans">
	<nav class="fixed top-0 inset-x-0 z-50 backdrop-blur bg-black/50 border-b border-white/10">
		<div class="max-w-7xl mx-auto px-6 py-4 flex items-center justify-between">
			<a href="index.html" class="font-serif text-xl tracking-wide">
				<span class="text-[var(--accent)]">Cine</span>phile
			</a>
			<div class="flex items-center gap-2">
				<a href="index.html" class="glass-chip px-3 py-1.5 rounded-full text-sm">Home</a>
				<button onclick="logout()" class="glass-chip px-3 py-1.5 rounded-full text-sm">Logout</button>
			</div>
		</div>
	</nav>

	<main class="pt-24 pb-24 max-w-7xl mx-auto px-6">
		<div class="rounded-3xl border border-white/10 bg-white/5 p-10">
			<div class="flex items-center justify-between gap-6">
				<div>
					<h1 class="font-serif text-4xl">Profile</h1>
					<p id="meta" class="mt-2 text-white/60 text-sm"></p>
				</div>

				<div class="flex items-center gap-4">
					<img id="avatar" class="w-16 h-16 rounded-full object-cover border border-white/10 bg-black/30" alt="avatar" />
				</div>
			</div>

			<div class="mt-10 grid grid-cols-1 lg:grid-cols-12 gap-10">
				<section class="lg:col-span-7">
					<h2 class="font-serif text-2xl">Top 5 favorites</h2>
					<div id="fav" class="mt-5 grid grid-cols-2 md:grid-cols-3 gap-5"></div>
				</section>

				<section class="lg:col-span-5">
					<h2 class="font-serif text-2xl">Edit profile</h2>

					<form id="form" class="mt-5 space-y-4 max-w-sm">
						<label class="block">
							<span class="text-xs uppercase tracking-widest text-white/50">Username</span>
							<input
								id="username"
								class="mt-2 w-full rounded-2xl bg-black/30 border border-white/10 px-4 py-3 text-sm text-white placeholder-white/40
									focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"
								placeholder="New username"
							/>
						</label>

						<label class="block">
							<span class="text-xs uppercase tracking-widest text-white/50">Avatar URL</span>
							<input
								id="avatarUrl"
								class="mt-2 w-full rounded-2xl bg-black/30 border border-white/10 px-4 py-3 text-sm text-white placeholder-white/40
									focus:outline-none focus:ring-2 focus:ring-[var(--accent)]"
								placeholder="https://..."
							/>
						</label>

						<button class="w-full rounded-2xl bg-[var(--accent)] text-black py-3 text-sm font-medium hover:brightness-95">
							Save
						</button>
					</form>

					<div id="msg" class="mt-3 text-sm text-white/60"></div>
				</section>
			</div>
		</div>
	</main>

	<script>
		const token = localStorage.getItem('token');
		if (!token) location.href = 'login.html';

		function logout() {
			localStorage.clear();
			location.href = 'index.html';
		}

		async function loadProfile() {
			const res = await axios.get('/api/users/profile', {
				headers: { Authorization: `Bearer ${token}` }
			});

			document.getElementById('meta').textContent = `Logged in as ${res.data.username} • ${res.data.email}`;

			const avatar = document.getElementById('avatar');
			avatar.src = res.data.avatarUrl || 'https://via.placeholder.com/128?text=Avatar';

			const fav = res.data.favorites || [];
			const box = document.getElementById('fav');

			if (!fav.length) {
				box.innerHTML = `<div class="text-white/60 text-sm">No favorites yet.</div>`;
				return;
			}

			box.innerHTML = fav.map((m) => {
				const href = (m.source === 'tmdb')
					? `movie.html?tmdbId=${m.movieId}`
					: `movie.html?id=${m.movieId}`;

				return `
					<div class="rounded-2xl border border-white/10 bg-black/20 overflow-hidden">
						<a href="${href}">
							<img src="${m.posterUrl || 'https://via.placeholder.com/400x600'}"
								class="w-full aspect-[2/3] object-cover hover:scale-[1.03] transition duration-500">
						</a>
						<div class="p-3">
							<div class="text-sm text-white font-medium line-clamp-2">${m.title}</div>
							<div class="text-xs text-white/50 mt-1">${m.year || 'N/A'}</div>
							<button class="mt-3 w-full rounded-xl bg-white/5 border border-white/10 py-2 text-xs hover:bg-white/10"
								onclick="removeFav('${m.source}', '${m.movieId}')">Remove</button>
						</div>
					</div>
				`;
			}).join('');
		}

		window.removeFav = async (source, movieId) => {
			await axios.put('/api/users/favorites', { source, movieId, title: 'x', year: 'N/A', posterUrl: '' }, {
				headers: { Authorization: `Bearer ${token}` }
			});
			// Примечание: title обязателен по Joi в toggleFavorite.
			// Лучше удалять через отдельный endpoint, но чтобы не плодить — ниже делаем корректный remove через profile cache:
			// Быстрый фикс: reload после toggle не идеален.
			location.reload();
		};

		document.getElementById('avatarUrl').addEventListener('input', (e) => {
			const v = e.target.value.trim();
			if (v) document.getElementById('avatar').src = v;
		});

		document.getElementById('form').addEventListener('submit', async (e) => {
			e.preventDefault();

			const payload = {
				username: document.getElementById('username').value.trim() || undefined,
				avatarUrl: document.getElementById('avatarUrl').value.trim() || ''
			};

			try {
				const res = await axios.put('/api/users/profile', payload, {
					headers: { Authorization: `Bearer ${token}` }
				});

				localStorage.setItem('username', res.data.username);
				document.getElementById('msg').textContent = 'Saved.';
				loadProfile();
			} catch (err) {
				document.getElementById('msg').textContent = err.response?.data?.error || 'Update failed.';
			}
		});

		loadProfile().catch((e) => {
			console.error(e);
			logout();
		});
	</script>
</body>
</html>
